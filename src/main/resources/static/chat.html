<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat Demo - Messenger Style</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .chat-app {
            display: flex;
            height: 100vh;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e4e6ea;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e4e6ea;
            background: #f8f9fa;
        }

        .sidebar-header h2 {
            color: #1c1e21;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details h4 {
            color: #1c1e21;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-details small {
            color: #65676b;
            font-size: 12px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .search-container {
            margin-top: 15px;
        }

        .search-container input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e4e6ea;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
            background: white;
        }

        .search-container input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        /* Login Section */
        .login-section {
            padding: 20px;
            border-bottom: 1px solid #e4e6ea;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .login-form input,
        .login-form select {
            padding: 10px;
            border: 1px solid #e4e6ea;
            border-radius: 6px;
            font-size: 14px;
        }

        .login-form button {
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .login-form button:hover {
            background: #0056b3;
        }

        .login-status {
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }

        .login-status.success {
            color: #28a745;
        }

        .login-status.error {
            color: #dc3545;
        }

        /* Conversations List */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
        }

        .conversation-item.active {
            background-color: #e7f3ff;
            border-left: 3px solid #007bff;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .conversation-name {
            font-weight: 600;
            color: #1c1e21;
            font-size: 14px;
        }

        .conversation-name.unread {
            font-weight: 700;
            color: #1a1a1a;
        }

        .conversation-time {
            font-size: 12px;
            color: #65676b;
        }

        .conversation-preview {
            color: #65676b;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            padding-right: 25px;
        }

        .conversation-preview.unread {
            color: #1a1a1a;
            font-weight: 500;
        }

        .unread-badge {
            position: absolute;
            right: 0;
            top: 0;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e4e6ea;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info h3 {
            color: #1c1e21;
            font-size: 18px;
            margin-bottom: 2px;
        }

        .chat-header-info small {
            color: #65676b;
            font-size: 13px;
        }

        .chat-header-actions button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-header-actions button:hover {
            background: #0056b3;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #0084ff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            color: #1c1e21;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-content {
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            color: #65676b;
            margin-top: 5px;
            text-align: center;
        }

        .message.sent .message-time {
            color: #0084ff;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e4e6ea;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e4e6ea;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: #0084ff;
        }

        .chat-input button {
            padding: 12px 20px;
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .chat-input button:hover {
            background: #0073e6;
        }

        .chat-input button:disabled {
            background: #e4e6ea;
            color: #65676b;
            cursor: not-allowed;
        }

        /* Status Messages */
        .status-message {
            text-align: center;
            color: #65676b;
            font-size: 14px;
            padding: 20px;
        }

        .no-conversations {
            text-align: center;
            color: #65676b;
            padding: 40px 20px;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Hidden Elements */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 1000;
                height: 100%;
            }

            .chat-main {
                display: none;
            }

            .show-chat .sidebar {
                display: none;
            }

            .show-chat .chat-main {
                display: flex;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="chat-app">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Login Section -->
            <div class="login-section" id="loginSection">
                <h3>Login to Chat</h3>
                <div class="login-form">
                    <select id="currentUser">
                        <option value="demo">demo</option>
                        <option value="test">test</option>
                        <option value="admin">admin</option>
                        <option value="user1">user1</option>
                        <option value="user2">user2</option>
                    </select>
                    <input type="password" id="password" value="password" placeholder="Password">
                    <button id="loginBtn" onclick="login()">Login</button>
                </div>
                <div id="loginStatus" class="login-status"></div>
            </div>

            <!-- User Info Section (hidden until login) -->
            <div class="sidebar-header hidden" id="userInfoSection">
                <h2>Messages</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div class="user-details">
                        <h4 id="currentUserName"></h4>
                        <small id="userStatus">Online</small>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>

                <!-- Search Conversations -->
                <div class="search-container">
                    <input type="text" id="searchConversations" placeholder="Search conversations..."
                        onkeyup="filterConversations(this.value)">
                </div>
            </div>

            <!-- Conversations List -->
            <div class="conversations-list" id="conversationsList">
                <div class="no-conversations">
                    <p>Login to see your conversations</p>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main" id="chatMain">
            <div class="chat-header">
                <div class="chat-header-info">
                    <h3 id="chatPartnerName">Select a conversation</h3>
                    <small id="chatPartnerStatus">Choose a conversation to start chatting</small>
                </div>
                <div class="chat-header-actions">
                    <button id="markReadBtn" onclick="markCurrentConversationAsRead()" style="display:none;">
                        Mark as Read
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="status-message">
                    Choose a conversation to start chatting
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type a message..." disabled>
                    <button onclick="sendMessage()" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentUser = null;
        let chatPartner = null;
        let authToken = null;
        let conversations = [];
        let currentConversation = null;

        function updateLoginStatus(message, type) {
            const statusDiv = document.getElementById('loginStatus');
            statusDiv.textContent = message;
            statusDiv.className = `login-status ${type}`;
        }

        function setLoading(loading) {
            const loginBtn = document.getElementById('loginBtn');
            if (loading) {
                loginBtn.textContent = 'Logging in...';
                loginBtn.disabled = true;
                document.body.classList.add('loading');
            } else {
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
                document.body.classList.remove('loading');
            }
        }

        function showUserInfo() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userInfoSection').classList.remove('hidden');

            // Update user avatar and name
            const userAvatar = document.getElementById('userAvatar');
            const currentUserName = document.getElementById('currentUserName');
            userAvatar.textContent = currentUser.charAt(0).toUpperCase();
            currentUserName.textContent = currentUser;
        }

        function showLoginSection() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('userInfoSection').classList.add('hidden');
            document.getElementById('conversationsList').innerHTML = '<div class="no-conversations"><p>Login to see your conversations</p></div>';
        }

        function login() {
            const username = document.getElementById('currentUser').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                updateLoginStatus('Please enter both username and password', 'error');
                return;
            }

            setLoading(true);
            updateLoginStatus('Logging in...', '');

            fetch('http://localhost:8080/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        authToken = data.data.token;
                        currentUser = username;

                        updateLoginStatus('Login successful!', 'success');
                        showUserInfo();

                        // Request notification permission
                        requestNotificationPermission();

                        // Connect to WebSocket
                        connectWebSocket();

                        // Debug: Test REST API after login
                        setTimeout(() => {
                            console.log('Testing REST API after login...');
                            debugRestAPI();
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Login failed');
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    updateLoginStatus(`Login failed: ${error.message}`, 'error');
                })
                .finally(() => {
                    setLoading(false);
                });
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                    }
                });
            }
        }

        function logout() {
            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
            }

            currentUser = null;
            chatPartner = null;
            authToken = null;
            conversations = [];
            currentConversation = null;

            showLoginSection();
            updateLoginStatus('Logged out', '');
            resetChatInterface();
        }

        function connectWebSocket() {
            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);

            const headers = {
                'Authorization': 'Bearer ' + authToken
            };

            stompClient.connect(headers, function (frame) {
                console.log('Connected: ' + frame);

                // Subscribe to chat messages
                stompClient.subscribe('/user/queue/chat', function (message) {
                    const data = JSON.parse(message.body);
                    handleChatMessage(data);
                });

                // Load conversations
                loadConversations();
            }, function (error) {
                console.log('STOMP error: ' + error);
                updateLoginStatus('WebSocket connection failed', 'error');
            });
        }

        function loadConversations() {
            if (stompClient && currentUser) {
                stompClient.send("/app/chat/subscribe", {}, {});
            }
        }

        function displayConversations(conversationsData) {
            conversations = conversationsData;
            const conversationsList = document.getElementById('conversationsList');

            if (conversations.length === 0) {
                conversationsList.innerHTML = '<div class="no-conversations"><p>No conversations yet. Start chatting!</p></div>';
                return;
            }

            // Group conversations by partner and get latest message for each
            const conversationMap = new Map();
            conversations.forEach(conv => {
                const partner = conv.senderUsername === currentUser ?
                    conv.receiverUsername : conv.senderUsername;

                if (!conversationMap.has(partner)) {
                    conversationMap.set(partner, {
                        partner: partner,
                        lastMessage: conv,
                        unreadCount: 0,
                        messages: []
                    });
                }

                const convData = conversationMap.get(partner);
                convData.messages.push(conv);

                // Update unread count
                if (conv.receiverUsername === currentUser && !conv.isRead) {
                    convData.unreadCount++;
                }

                // Keep the latest message
                if (new Date(conv.timestamp) > new Date(convData.lastMessage.timestamp)) {
                    convData.lastMessage = conv;
                }
            });

            // Convert to array and sort by latest message time
            const sortedConversations = Array.from(conversationMap.values())
                .sort((a, b) => new Date(b.lastMessage.timestamp) - new Date(a.lastMessage.timestamp));

            let html = '';
            sortedConversations.forEach(conv => {
                const isActive = currentConversation === conv.partner;
                const hasUnread = conv.unreadCount > 0;

                html += `
                    <div class="conversation-item ${isActive ? 'active' : ''}" 
                         onclick="selectConversation('${conv.partner}')">
                        <div class="conversation-header">
                            <span class="conversation-name ${hasUnread ? 'unread' : ''}">${conv.partner}</span>
                            <span class="conversation-time">${formatTime(conv.lastMessage.timestamp)}</span>
                        </div>
                        <div class="conversation-preview ${hasUnread ? 'unread' : ''}">
                            ${conv.lastMessage.message}
                            ${hasUnread ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
            });

            conversationsList.innerHTML = html;
        }

        function selectConversation(partner) {
            chatPartner = partner;
            currentConversation = partner;

            // Update UI
            document.getElementById('chatPartnerName').textContent = partner;
            document.getElementById('chatPartnerStatus').textContent = 'Active now';
            document.getElementById('messageInput').disabled = false;
            document.querySelector('.chat-input button').disabled = false;

            // Show mark as read button if there are unread messages
            const unreadCount = getUnreadCountForPartner(partner);
            if (unreadCount > 0) {
                document.getElementById('markReadBtn').style.display = 'inline-block';
                document.getElementById('markReadBtn').textContent = `Mark as Read (${unreadCount})`;
            } else {
                document.getElementById('markReadBtn').style.display = 'none';
            }

            // Update active conversation in sidebar
            updateActiveConversation(partner);

            // Load conversation using REST API instead of WebSocket
            loadConversationViaRest(partner);

            // Mark conversation as read
            markConversationAsRead(partner);
        }

        function loadConversationViaRest(partner) {
            console.log('Loading conversation with', partner, 'via REST API');

            fetch(`http://localhost:8080/api/chat/conversation/${partner}`, {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('REST API response for conversation:', data);
                    if (data.success) {
                        displayConversation(data.data);
                    } else {
                        console.error('Failed to load conversation:', data.message);
                        // Show error message in chat area
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = '<div class="status-message">Error loading conversation: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading conversation via REST:', error);
                    // Show error message in chat area
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '<div class="status-message">Failed to load conversation. Please try again.</div>';
                });
        }

        function getUnreadCountForPartner(partner) {
            // Find the conversation in our local data
            const conversation = conversations.find(conv => {
                const convPartner = conv.senderUsername === currentUser ?
                    conv.receiverUsername : conv.senderUsername;
                return convPartner === partner;
            });

            if (conversation && conversation.receiverUsername === currentUser && !conversation.isRead) {
                return 1; // For simplicity, just return 1 if unread
            }
            return 0;
        }

        function markConversationAsRead(partner) {
            if (currentUser) {
                // Use REST API for marking conversation as read
                fetch(`http://localhost:8080/api/chat/conversation/${partner}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Conversation marked as read successfully');
                            // Refresh conversations to update unread counts
                            loadConversations();
                        } else {
                            console.error('Failed to mark conversation as read:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error marking conversation as read:', error);
                    });
            }
        }

        function updateActiveConversation(partner) {
            // Remove active class from all conversations
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to selected conversation
            const conversationItems = document.querySelectorAll('.conversation-item');
            conversationItems.forEach(item => {
                if (item.querySelector('.conversation-name').textContent === partner) {
                    item.classList.add('active');
                }
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (message && chatPartner && stompClient) {
                const request = {
                    receiverUsername: chatPartner,
                    message: message
                };

                stompClient.send("/app/chat/send", {}, JSON.stringify(request));
                messageInput.value = '';
            }
        }

        function handleChatMessage(data) {
            console.log('=== RECEIVED CHAT MESSAGE ===');
            console.log('Full data:', data);
            console.log('Type:', data.type);
            console.log('Data content:', data.data);
            console.log('Data length:', data.data ? data.data.length : 'undefined');

            if (data.type === 'CHAT_CONVERSATIONS_INITIAL') {
                console.log('Loading initial conversations...');
                displayConversations(data.data);
            } else if (data.type === 'CHAT_CONVERSATION_LOADED') {
                console.log('Loading specific conversation...');
                console.log('Conversation data:', data.data);
                displayConversation(data.data);
            } else if (data.type === 'CHAT_MESSAGE') {
                console.log("my message :", data)
                // Only display if this is a message from someone else
                if (data.data.senderUsername !== currentUser) {
                    displayMessage(data.data);

                    // Play notification sound if not in current conversation
                    if (currentConversation !== data.data.senderUsername) {
                        playNotificationSound();
                        showNewMessageNotification(data.data.senderUsername, data.data.message);
                    }

                    // Refresh conversations to show latest message
                    loadConversations();
                }
            } else if (data.type === 'CHAT_MESSAGE_SENT') {
                // This is confirmation of our own message
                // Add it to the current conversation display
                if (data.data.senderUsername === currentUser) {
                    displayMessage(data.data);
                }
                // Refresh conversations to show latest message
                loadConversations();
            } else if (data.type === 'ERROR') {
                console.error('Chat error:', data.data.message);
            }
        }

        function playNotificationSound() {
            // Create a simple notification sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        function showNewMessageNotification(sender, message) {
            // Show a browser notification if supported
            if (Notification.permission === 'granted') {
                new Notification(`New message from ${sender}`, {
                    body: message,
                    icon: '/favicon.ico'
                });
            }
        }

        function displayConversation(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            if (messages.length === 0) {
                chatMessages.innerHTML = '<div class="status-message">No messages yet. Start the conversation!</div>';
                return;
            }

            messages.forEach(message => {
                displayMessage(message);
            });
        }

        function filterConversations(searchTerm) {
            const conversationItems = document.querySelectorAll('.conversation-item');
            const searchLower = searchTerm.toLowerCase();

            conversationItems.forEach(item => {
                const partnerName = item.querySelector('.conversation-name').textContent.toLowerCase();
                const messagePreview = item.querySelector('.conversation-preview').textContent.toLowerCase();

                if (partnerName.includes(searchLower) || messagePreview.includes(searchLower)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const isSent = message.senderUsername === currentUser;

            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-sender">${isSent ? 'You' : message.senderUsername}</div>
                    <div class="message-content">${message.message}</div>
                </div>
                <div class="message-time">${formatTime(message.timestamp)}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);

            if (diffInHours < 24) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffInHours < 48) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }

        function resetChatInterface() {
            document.getElementById('chatPartnerName').textContent = 'Select a conversation';
            document.getElementById('chatMessages').innerHTML = '<div class="status-message">Choose a conversation to start chatting</div>';
            document.getElementById('messageInput').disabled = true;
            document.querySelector('.chat-input button').disabled = true;
        }

        function markCurrentConversationAsRead() {
            if (currentConversation) {
                // Use REST API for marking current conversation as read
                fetch(`http://localhost:8080/api/chat/conversation/${currentConversation}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Current conversation marked as read successfully');
                            document.getElementById('markReadBtn').style.display = 'none';
                            // Refresh conversations to update unread counts
                            loadConversations();
                        } else {
                            console.error('Failed to mark current conversation as read:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error marking current conversation as read:', error);
                    });
            }
        }

        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle Enter key in password field
        document.getElementById('password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Auto-login as demo user on page load (optional)
        // Uncomment the line below if you want auto-login
        // window.onload = function() { login(); };

        // Debug function to test REST API directly
        function debugRestAPI() {
            if (!authToken) {
                console.log('Not logged in yet');
                return;
            }

            console.log('=== DEBUG REST API ===');
            console.log('Current user:', currentUser);
            console.log('Auth token:', authToken ? 'Present' : 'Missing');

            // Test conversations endpoint
            fetch('http://localhost:8080/api/chat/conversations', {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Conversations API response:', data);
                })
                .catch(error => {
                    console.error('Conversations API error:', error);
                });

            // Test specific conversation endpoint
            if (currentConversation) {
                fetch(`http://localhost:8080/api/chat/conversation/${currentConversation}`, {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Specific conversation API response:', data);
                    })
                    .catch(error => {
                        console.error('Specific conversation API error:', error);
                    });
            }
        }

        // Make debug function available globally
        window.debugRestAPI = debugRestAPI;
    </script>
</body>

</html>